---
- name: Delete containers and artifacts
  hosts: "_bastion"
  environment:
    AWS_ACCESS_KEY_ID: "{{ access_key_v }}"
    AWS_SECRET_ACCESS_KEY: "{{ secret_key_v }}"
    AWS_REGION: "{{ region_v }}"
  tasks:

    # Delete Cognito resources
    - name: Find Cognito User Pool Client by name
      cognito_userpoolclient:
        state: present
        name: "{{ prefix_v }}-alb-client"
        user_pool_id: "{{ cognito_user_pool_id }}"
      register: cognito_client_id_r
      ignore_errors: true

    - name: Delete Managed Login Branding for the app client
      cognito_managed_login_branding:
        state: absent
        user_pool_id: "{{ cognito_user_pool_id }}"
        client_id: "{{ cognito_client_id_r.client.client_id }}"
      when: cognito_client_id_r.client is defined

    - name: Delete Cognito User Pool Client
      cognito_userpoolclient:
        state: absent
        name: "{{ prefix_v }}-alb-client"
        user_pool_id: "{{ cognito_user_pool_id }}"

    # Delete Route 53 records
    - name: Delete Route 53 A record for ALB
      amazon.aws.route53:
        state: absent
        zone: "{{ (n7m_domain | split('.'))[-2:] | join('.') }}"
        record: "{{ prefix_v + '.' + n7m_domain }}"
        type: A

    # Delete the services
    - name: Delete ECS services
      ecs_service:
        state: absent
        name: "{{ prefix_v }}-{{ item }}-svc"
        cluster: "{{ prefix_v }}-ecs-cluster"
        force_deletion: true
        # wait: true
      loop:
        - api
        - ui
        - mcp
      # retries: 5
      # delay: 10
      register: services_delete_result

    # Delete the ALB
    - name: Delete Application Load Balancer
      amazon.aws.elb_application_lb:
        name: "{{ prefix_v }}-alb"
        state: absent
        wait: true

    # Delete the target groups
    - name: Delete target groups
      community.aws.elb_target_group:
        name: "{{ prefix_v }}-n7m-{{ item }}-tg"
        state: absent
      loop:
        - ui
        - api
        - mcp

    # Delete the Cloud Map namespace (wait for services to delete)
    - name: Delete Cloud Map namespace (wait for services to delete)
      cloudmap_namespace:
        state: absent
        name: "{{ prefix_v }}-ecs-cluster"
      retries: 15  # Wait for services to delete
      delay: 20

    # Delete the ECS cluster
    - name: Deallocate ECS cluster
      community.aws.ecs_cluster:
        name: "{{ prefix_v }}-ecs-cluster"
        state: absent
      register: cluster_delete_result
      # retries: 5
      # delay: 10
      until: cluster_delete_result is succeeded

    - name: Delete IAM task role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-container-task-role"
        state: absent

    - name: Delete IAM execution role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-container-execution-role"
        state: absent

    - name: Delete task definitions
      ecs_taskdefinition:
        family: "{{ item }}"
        state: absent
      loop:
        - "{{ prefix_v }}-api-td"
        - "{{ prefix_v }}-ui-td"
        - "{{ prefix_v }}-mcp-td"

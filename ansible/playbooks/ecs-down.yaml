---
- name: Delete containers and artifacts
  hosts: "_bastion"
  environment:
    AWS_ACCESS_KEY_ID: "{{ access_key_v }}"
    AWS_SECRET_ACCESS_KEY: "{{ secret_key_v }}"
    AWS_REGION: "{{ region_v }}"
  tasks:

    # Delete Route 53 records
    - name: Delete Route 53 A record for ALB
      amazon.aws.route53:
        state: absent
        zone: "{{ (n7m_domain | split('.'))[-2:] | join('.') }}"
        record: "{{ prefix_v + '.' + n7m_domain }}"
        type: A

    # Delete the services
    - name: Delete ECS services
      ecs_service:
        state: absent
        name: "{{ prefix_v }}-{{ item }}-svc"
        cluster: "{{ prefix_v }}-ecs-cluster"
        force_deletion: true
        # wait: true
      loop:
        - web
        - api
        - ui
        - mcp
      # retries: 5
      # delay: 10
      register: services_delete_result

    # Delete the ALB
    - name: Delete Application Load Balancer
      amazon.aws.elb_application_lb:
        name: "{{ prefix_v }}-alb"
        state: absent
        wait: true

    # Delete the target group
    - name: Delete target group
      community.aws.elb_target_group:
        name: "{{ prefix_v }}-n7m-web-tg"
        state: absent

    # Delete the Cloud Map namespace (wait for services to delete)
    - name: Delete Cloud Map namespace (wait for services to delete)
      cloudmap_namespace:
        state: absent
        name: "{{ prefix_v }}-ecs-cluster"
      retries: 15  # Wait for services to delete
      delay: 20

    # Delete the ECS cluster
    - name: Deallocate ECS cluster
      community.aws.ecs_cluster:
        name: "{{ prefix_v }}-ecs-cluster"
        state: absent
      register: cluster_delete_result
      # retries: 5
      # delay: 10
      until: cluster_delete_result is succeeded

    # Clean up IAM roles and policies (no charge, but good practice)

    # Check for IAM role existence first to ensure idempotence
    #
    # - name: Check if IAM task role exists
    #   amazon.aws.iam_role_info:
    #     name: "{{ prefix_v }}-container-task-role"
    #   register: task_role_info
    #
    # - name: Check if IAM execution role exists
    #   amazon.aws.iam_role_info:
    #     name: "{{ prefix_v }}-container-execution-role"
    #   register: execution_role_info
    #
    # - name: Delete execute command policy from task role
    #   amazon.aws.iam_policy:
    #     state: absent
    #     iam_type: role
    #     iam_name: "{{ prefix_v }}-container-task-role"
    #     policy_name: "{{ prefix_v }}-execute-command-policy"
    #   when: task_role_info.iam_roles | length > 0
    #
    # - name: Delete credentials access policy from execution role
    #   amazon.aws.iam_policy:
    #     state: absent
    #     iam_type: role
    #     iam_name: "{{ prefix_v }}-container-execution-role"
    #     policy_name: "{{ prefix_v }}-access-credentials"
    #   when: execution_role_info.iam_roles | length > 0

    - name: Delete IAM task role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-container-task-role"
        state: absent

    - name: Delete IAM execution role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-container-execution-role"
        state: absent

    - name: Delete task definitions
      ecs_taskdefinition:
        family: "{{ item }}"
        state: absent
      loop:
        - "{{ prefix_v }}-n7m-feed"
        - "{{ prefix_v }}-api-td"
        - "{{ prefix_v }}-ui-td"
        - "{{ prefix_v }}-mcp-td"
        - "{{ prefix_v }}-web-td"
        # Some leftovers just to be sure
        - "{{ prefix_v }}-efs-configurator"
